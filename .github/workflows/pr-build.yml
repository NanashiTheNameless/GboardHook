name: PR Build

on:
  pull_request:
    branches:
      - main
      - master

permissions:
  contents: read

concurrency:
  group: pr-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  build-debug:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Save PR number
        run: |
          mkdir -p ./pr
          echo ${{ github.event.pull_request.number }} > ./pr/NR
          echo ${{ github.event.pull_request.head.sha }} > ./pr/SHA

      - name: Gather variables
        id: vars
        run: |
          GIT_SHA7=$(git rev-parse --short HEAD)
          echo "GIT_SHA7=$GIT_SHA7"
          echo "GIT_SHA7=$GIT_SHA7" >> "$GITHUB_OUTPUT"
          DATE=$(date -u +'%Y.%m.%d')
          echo "DATE=$DATE"
          echo "DATE=$DATE" >> "$GITHUB_OUTPUT"
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "PR_NUMBER=$PR_NUMBER"
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Replace "localbuild" in version with PR info
        run: |
          sed -i "s/localbuild/pr${{ steps.vars.outputs.PR_NUMBER }}-${{ steps.vars.outputs.GIT_SHA7 }}/g" app/build.gradle

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: "25"

      - name: Ensure keystore directory exists
        run: mkdir -p app/AndroidKeystore

      - name: Generate temporary debug keystore with 14-day validity
        run: |
          keytool -genkeypair \
            -keystore app/AndroidKeystore/debug-pr.jks \
            -alias debug-pr-key \
            -keyalg RSA \
            -keysize 2048 \
            -validity 14 \
            -storepass debug-pr-password \
            -keypass debug-pr-password \
            -dname "CN=GitHub PR Debug Key, OU=CI, O=GboardHook-PR-Test-Build"

      - name: Build debug APK
        env:
          KEYSTORE_FILE: AndroidKeystore/debug-pr.jks
          KEYSTORE_PASSWORD: debug-pr-password
          KEY_ALIAS: debug-pr-key
          KEY_PASSWORD: debug-pr-password
        run: |
          ./gradlew --no-daemon assembleDebug

      - name: Locate APK
        id: locate_apk
        run: |
          apk_path=$(ls app/build/outputs/apk/debug/*.apk | head -n 1)
          echo "apk_path=$apk_path" >> "$GITHUB_OUTPUT"
          apk_name=$(basename "$apk_path")
          echo "apk_name=$apk_name" >> "$GITHUB_OUTPUT"

      - name: Upload debug APK as artifact
        uses: actions/upload-artifact@v6
        with:
          name: pr-build-${{ steps.vars.outputs.PR_NUMBER }}
          path: |
            pr/
            ${{ steps.locate_apk.outputs.apk_path }}
          retention-days: 14
          if-no-files-found: error
