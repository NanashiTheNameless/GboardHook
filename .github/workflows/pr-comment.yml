name: PR Comment

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
      pr_sha:
        required: true
        type: string
      apk_name:
        required: true
        type: string
      artifact_name:
        required: true
        type: string
      run_id:
        required: true
        type: string
      retention_days:
        required: true
        type: string

permissions:
  pull-requests: write
  issues: write

jobs:
  pr-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const prSha = '${{ inputs.pr_sha }}';
            const apkName = '${{ inputs.apk_name }}';
            const runId = ${{ inputs.run_id }};
            const artifactName = '${{ inputs.artifact_name }}';
            const retentionDays = ${{ inputs.retention_days }};
            const { repo, owner } = context.repo;
            
            const commentBody = [
              '## [BUILD] Testing/Debug Build Ready',
              '',
              `A debug APK has been built for this PR and is available for ${retentionDays} days.`,
              '',
              `**Download**: [${artifactName}](https://nightly.link/${owner}/${repo}/actions/runs/${runId}/${artifactName})`,
              '',
              '**Build Info**:',
              `- Commit: \`${prSha.substring(0, 7)}\``,
              `- APK: \`${apkName}\``,
              '',
              '---',
              '',
              '## ⚠ CRITICAL WARNING - READ BEFORE DOWNLOADING ⚠',
              '',
              '**THIS IS AN UNTESTED PR BUILD FOR TESTING PURPOSES ONLY**',
              '',
              '⚠ DANGER - USE AT YOUR OWN RISK ⚠',
              '',
              '- ✖ NOT SAFE: This build has NOT been reviewed or tested for security vulnerabilities',
              '- ✖ UNVERIFIED CODE: Contains unreviewed code changes that may be malicious or buggy',
              '- ✖ NO WARRANTY: This build comes with ABSOLUTELY NO WARRANTY of any kind',
              '- ✖ POTENTIAL RISKS: May contain malware, backdoors, data theft code, or cause device instability',
              `- ⏲ TEMPORARY KEY: Signed with a debug key that expires in ${retentionDays} days`,
              '',
              '⚠ WARNING: DO NOT INSTALL UNLESS:',
              '- ✔ You are an experienced developer who understands the risks',
              '- ✔ You have reviewed the PR code changes thoroughly',
              '- ✔ You accept full responsibility for any damage or data loss',
              '- ✔ You understand this may compromise your device security',
              '',
              '**BY DOWNLOADING THIS BUILD, YOU ACKNOWLEDGE AND ACCEPT ALL RISKS.**',
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: commentBody
            });
