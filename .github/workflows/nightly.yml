name: Nightly Build

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: nightly
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gather variables
        id: vars
        run: |
          GIT_SHA7=$(git rev-parse --short HEAD)
          echo "GIT_SHA7=$GIT_SHA7"
          echo "GIT_SHA7=$GIT_SHA7" >> "$GITHUB_OUTPUT"
          DATE=$(date -u +'%Y.%m.%d')
          echo "DATE=$DATE"
          echo "DATE=$DATE" >> "$GITHUB_OUTPUT"

      - name: Replace "localbuild" in version with commit SHA7
        id: name_replace
        run: |
          sed -i "s/localbuild/${{ steps.vars.outputs.GIT_SHA7 }}/g" app/build.gradle

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: "25"

      - name: Ensure keystore directory exists
        run: mkdir -p app/AndroidKeystore

      - name: Decode keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 -d > app/AndroidKeystore/release-key.jks

      - name: Build release APK
        env:
          KEYSTORE_FILE: AndroidKeystore/release-key.jks
          KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          ./gradlew --no-daemon assembleRelease

      - name: Locate APK
        id: locate_apk
        run: |
          apk_path=$(ls app/build/outputs/apk/release/*.apk | head -n 1)
          echo "apk_path=$apk_path" >> "$GITHUB_OUTPUT"

      - name: Create or update nightly tag
        uses: NanashiTheNameless/action-create-tag@main
        with:
          tag: nightly
          message: "Nightly build"
          force_push_tag: true
          tag_exists_error: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure nightly release exists
        id: release
        uses: actions/github-script@v8
        with:
          script: |
            const tag = 'nightly';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function findRelease() {
              try {
                return await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              } catch (error) {
                if (error.status !== 404) throw error;
                return null;
              }
            }

            const releaseName = `Nightly (${new Date().toISOString().slice(0, 10)})`;
            let release = await findRelease();

            const apkAssetName = "GboardHook-nightly-${{ steps.vars.outputs.DATE }}-${{ steps.vars.outputs.GIT_SHA7 }}.apk";
            const apkUrl = `https://github.com/${owner}/${repo}/releases/download/${tag}/${apkAssetName}`;
            const releaseBody = `Download the latest APK: [${apkAssetName}](${apkUrl})`;

            if (!release) {
              release = await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tag,
                name: releaseName,
                draft: false,
                prerelease: false,
                body: releaseBody,
              });
            } else {
              release = { data: (await github.rest.repos.updateRelease({
                owner,
                repo,
                release_id: release.data.id,
                tag_name: tag,
                name: releaseName,
                draft: false,
                prerelease: false,
                body: releaseBody,
              })).data };
            }

            core.setOutput('upload_url', release.data.upload_url);
            core.setOutput('release_id', release.data.id);

      - name: Publish nightly asset
        uses: NanashiTheNameless/deploy-nightly@master
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          release_id: ${{ steps.release.outputs.release_id }}
          asset_path: ${{ steps.locate_apk.outputs.apk_path }}
          asset_name: "GboardHook-nightly-${{ steps.vars.outputs.DATE }}-${{ steps.vars.outputs.GIT_SHA7 }}.apk"
          asset_content_type: application/vnd.android.package-archive
          max_releases: 5
          ignore_hash: false
          token: ${{ secrets.GITHUB_TOKEN }}
